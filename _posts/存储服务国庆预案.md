# 存储服务国庆预案


## 宁波机房

#### 一、整体状态

***ps:统计近7天数据***

||平均值|峰值|备注|
|---|---|---|---|
|QPS|1541|3113||
|平均响应时间|98ms|248ms||
|上传带宽|1.18Gbps|3.06Gbps||
|下载带宽|5.05Gbps|11.14Gbps||

#### 二、图片处理

图片处理共有14台机器，每台机器的并发限制为：10。  
目前图片处理机器集群的压力较小，4台CPU为E5-2650 v2的机器平均CPU空闲在80%左右，高峰期在70%左右，另外10台E5-2650 v4的机器平均CPU空闲在90%左右，高峰在80%左右。因此，打算调高图片处理机器的并发限制，同时减少图片处理机器，用于视频处理。

查看单台机器的负载情况如下：

||平均值|峰值|备注|
|---|---|---|---|
|QPS|37|78||
|平均响应时间|97ms|132ms||
|下载带宽|5.37Mbps|11.43Mbps||


#### 三、视频处理

目前视频处理的负载大概如下：

||平均值|峰值|备注|
|---|---|---|---|
|QPS|14|30||
|平均响应时间|97ms|132ms||
|下载带宽|5.37Mbps|11.43Mbps||

集群负载较高。


#### 四、上传下载

目前上传有3台机器，下载7台机器，其中7台下载机器均使用的是万兆网卡。  
查看机器负载，CPU及内存都有非常大的冗余。对于下载机器，单台机器带宽峰值只有1.75Gbps，上传单台机器带宽峰值为768Mbps，冗余充足。

||平均值|峰值|备注|
|---|---|---|---|
|QPS|1086|2098||
|GET请求平均响应时间|72ms|254ms||
|POST请求平均响应时间|167ms|216ms||
|上传带宽|1.18Gbps|3.06Gbps||
|下载带宽|4.95Gbps|10.93Gbps||


## 北京机房

#### 一、整体情况

北京机房目前有4台机器，主要负责直播回放的上传，截帧服务，及同步到宁波。

其中atlas-web-8891服务状态如下：

||平均值|峰值||
|---|---|---|---|
|QPS|68|191||
|GET平均响应时间|50ms|69ms||
|POST平均响应时间|64ms|100ms||
|下载带宽|35.9Mbps|52.1Mbps|
|上传带宽|34.5Mbps|54.3Mbps|

查看每台机器负载，CPU空闲占比平均90%，带宽峰值300Mbps，机器冗余充足。

* 直播同步服务，队列堆积在100以内，基本没有没有堆积。其中同步处理机并发数最高为80x4，满足冗余。
* 异步截图服务，队列堆积在600左右，堆积情况良好。其中fop处理机的并发量为10x4，考虑可以提高。
* 美拍同步服务，目前有3台机器负责美拍同步服务，队列堆积在600左右，考虑可以提高处理并发。

## 嘉兴机房

### 一、整体情况

嘉兴机房目前有3台机器负责所有服务，16台机器负责视频转码，主要包括H265转码。查看机器负载，可能的瓶颈在CPU。（待完善）

## 服务预案

根据当前存储服务的状态，为了保证服务的稳定性，打算做出以下调整：

* 宁波机房
    - 下线4台图片处理机器（E5-2650 v4），将剩余图片处理机器的并发限制调整到20（之前为10）。
    - 将这2台机器添加到机器处理集群。另外两台机器留于备用。
* 北京机房
    - 调整异步截图服务的并发量到15x4(之前为10x4)
    - 暂时不对美拍同步服务做调整
* 嘉兴机房

#### 可能出现的问题

* 上传带宽超出预期。目前上传带宽冗余有12G，线上峰值带宽为3G，冗余完全足够。考虑如果上传机器出现问题，首先联系运维看能否快速解决。否则方案一为切换到嘉兴上传服务，方案二为切换到七牛服务。
* 下载带宽超出预期。目前下载带宽可用冗余预计有35G，线上峰值带宽为11G，冗余足够。考虑如果机器出现问题，首先联系运维看能否快速解决。否则方案一为切换到七牛下载（待补充）
* 图片处理请求量超出预期。目前图片处理的冗余充足，考虑如果出现问题，方案为上线两台备用的机器到图片处理集群。
* 视频处理请求量超出预期。方案为上线两台备用机器到图片处理集群。如果该两台机器已经用于图片处理，则减少嘉兴H265转码机器，临时用于同步视频处理。
* 同步服务延迟。同步服务延迟由于对前端影响较小，可以接受一般情况下的堆积。如果堆积较为严重，方案为在服务低峰期开大处理并发进行消费。
* 异步处理服务延迟。异步处理服务可以接受一般情况下的堆积，如果堆积较为严重，方案为在服务低峰期从其他服务下线几台机器用于异步处理消费，在高峰期前再加回原先服务集群。
* Nginx机器瓶颈。目前Nginx有11台，冗余充足（待完善）







